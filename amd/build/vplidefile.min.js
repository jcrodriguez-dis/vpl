define(["jquery","jqueryui","mod_vpl/vplutil"],function(a,b,c){if("undefined"!=typeof d)return d;var d=function(b,e,f,g,h){var i="#vpl_file"+b,j="#vpl_tab_name"+b,k=e,l=!0,m=!1,n=this;this.getId=function(){return b},this.getTabNameId=function(){return j},this.getTId=function(){return i},this.getFileName=function(){return k},this.resetModified=function(){l=!1,this.setFileName(k)},this.getTabPos=function(){return g.getTabPos(this)},this.isOpen=function(){return m},this.isModified=function(){return l},this.change=function(){l||(l=!0,g.generateFileList(),this.setFileName(k)),c.longDelay("setModified",g.setModified)},this.setFileName=function(b){if(!c.validPath(b))return!1;if(b!=k&&(k=b,n.change()),!m)return!0;var d=c.getFileName(b);d.length>20&&(d=d.substring(0,16)+"...");var e=(l?c.iconModified():"")+d;return e+=this.getTabPos()<g.minNumberOfFiles?c.iconRequired():c.iconClose(),a(j+" a").html(e),d!=b&&a(j+" a").attr("title",b),l&&g.adjustTabsTitles(!1),this.langSelection(),!0},this.getContent=function(){return f},this.setContent=function(a){f=a},this.destroy=function(){a(j).remove(),a(i).remove()},this.adjustSize=function(){if(!m)return!1;var b=a(i),c=b.parent();if(0!==b.length){var d=b.height(),e=b.width(),f=c.height();f-=b.position().top;var g=a("#vpl_tabs_scroll").width();return(f!=d||g!=e)&&(a(b).height(f),a(b).width(g),!0)}},this.gotoLine=c.doNothing,this.setReadOnly=c.doNothing,this.focus=c.doNothing,this.blur=c.doNothing,this.undo=c.doNothing,this.redo=c.doNothing,this.selectAll=c.doNothing,this.open=c.doNothing,this.hasUndo=c.returnFalse,this.hasRedo=c.returnFalse,this.hasSelectAll=c.returnFalse,this.hasFind=c.returnFalse,this.hasFindReplace=c.returnFalse,this.hasNext=c.returnFalse,this.find=c.doNothing,this.replace=c.doNothing,this.next=c.doNothing,this.getAnnotations=function(){return[]},this.setAnnotations=c.doNothing,this.setFontSize=c.doNothing,this.setTheme=c.doNothing,this.clearAnnotations=c.doNothing,this.langSelection=c.doNothing,this.isBinary=function(){return!1},this.extendToCodeEditor=function(){var d=null,e=null,h=g.readOnly;this.getContent=function(){return m?d.getValue():f},this.setContent=function(a){f=a,m&&d.setValue(a)},this.oldDestroy=this.destroy,this.destroy=function(){m&&d.destroy(),this.oldDestroy()},this.setFontSize=function(a){m&&d.setFontSize(a)},this.oldAdjustSize=this.adjustSize,this.adjustSize=function(){return!!this.oldAdjustSize()&&(d.resize(),!0)},this.gotoLine=function(a){m&&(d.gotoLine(a,0),d.scrollToLine(a,!0),d.focus())},this.setReadOnly=function(a){h=a,m&&d.setReadOnly(a)},this.focus=function(){m&&(a(i).removeClass("ui-widget-content ui-tabs-panel"),a(i).addClass("ui-corner-bottom"),this.adjustSize(),d.focus())},this.blur=function(){m&&d.blur()},this.undo=function(){m&&(d.undo(),d.focus())},this.redo=function(){m&&(d.redo(),d.focus())},this.selectAll=function(){m&&(d.selectAll(),d.focus())},this.hasUndo=function(){return!!m&&e.getUndoManager().hasUndo()},this.hasRedo=function(){return!!m&&e.getUndoManager().hasRedo()},this.hasSelectAll=c.returnTrue,this.hasFind=c.returnTrue,this.hasFindReplace=c.returnTrue,this.hasNext=c.returnTrue,this.find=function(){m&&d.execCommand("find")},this.replace=function(){m&&d.execCommand("replace")},this.next=function(){m&&d.execCommand("findnext")},this.getAnnotations=function(){return m?e.getAnnotations():[]},this.setAnnotations=function(a){if(m)return e.setAnnotations(a)},this.clearAnnotations=function(){if(m)return e.clearAnnotations()},this.langSelection=function(){if(m){var a=c.fileExtension(k),b="text";""!==a&&(b=c.langType(a)),e.setMode("ace/mode/"+b)}},this.getEditor=function(){return!!m&&d},this.setTheme=function(a){m&&d.setTheme("ace/theme/"+a)},this.$_GET=function(a){var b={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(a,c,d){b[c]=void 0!==d?d:""}),a?b[a]?b[a]:null:b},this.check_difference=function(){a.ajax({method:"POST",url:"../similarity/diff_check_requested_files.php",data:{id:this.$_GET("id"),name:k,val:d.getValue()}}).done(function(a){var b,c="ace-changed";for(b=0;b<a.length;b++)"="!=a[b].type?(d.session.removeGutterDecoration(a[b].ln2-1,c),d.session.addGutterDecoration(a[b].ln2-1,c)):d.session.removeGutterDecoration(a[b].ln2-1,c)})},this.open=function(){function j(){var b=a(i+" div.ace_search");if(b.length){b.on("drop",g.dropHandler);var c=a("button.ace_searchbtn_close");c.css({marginLeft:"1em",marginRight:"1em"}),c.trigger("click")}else setTimeout(j,50)}if("undefined"==typeof ace)return void c.loadScript(["../editor/ace9/ace.js","../editor/ace9/ext-language_tools.js"],function(){n.open()});if(m)return!1;a(i).removeClass("ui-widget-content ui-tabs-panel"),a(i).addClass("ui-corner-bottom"),ace.require("ext/language_tools"),m=!0,d=ace.edit("vpl_file"+b),e=d.getSession(),d.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),d.setFontSize(g.getFontSize()),d.setTheme("ace/theme/"+g.getTheme()),this.setFileName(k),d.setValue(f),d.gotoLine(0,0),d.setReadOnly(h),e.setUseSoftTabs(!0),e.setTabSize(4),e.setUndoManager(new ace.UndoManager),d.execCommand("replace"),this.check_difference(),d.on("change",function(){n.change(),n.check_difference()}),setTimeout(j,5);var l=d.onPaste;return d.onPaste=function(a){g.restrictedEdit?d.insert(g.getClipboard()):l.call(d,a)},d.on("copy",function(a){g.setClipboard(a)}),a(i).on("paste","*",g.restrictedPaste),a(i+" div.ace_content").on("drop",g.dropHandler),a(i+" div.ace_content").on("dragover",g.dragoverHandler),this.adjustSize(),d},this.close=function(){m=!1,null!==d&&(f=d.getValue(),d.destroy(),d=null,e=null)}},this.adaptBlockly=function(){"undefined"==typeof Blockly.PHP.workspaceToCodeOld&&(Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode,Blockly.PHP.workspaceToCode=function(a){return"<?\n"+Blockly.PHP.workspaceToCodeOld(a)}),"undefined"==typeof Blockly.Python.workspaceToCodeOld&&(Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode,Blockly.Python.workspaceToCode=function(a){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(a)})},this.extendToBlockly=function(){this.firstFocus=!0,this.workspacePlayground=!1,this.focus=function(){n.firstFocus&&(n.workspacePlayground?(n.firstFocus=!1,Blockly.Events.disable(),n.setContent(f),c.adjustBlockly(n.workspacePlayground,10,10),n.workspacePlayground.scrollX=0,n.workspacePlayground.scrollY=0,Blockly.svgResize(n.workspacePlayground),Blockly.resizeSvgContents(n.workspacePlayground),n.adjustSize(),Blockly.Events.enable()):c.longDelay("focus",n.focus))},this.adjustSize=function(){if(!m||!this.workspacePlayground)return!1;var b=a(i);if(0===b.length)return!1;var c=b.parent(),d=c.height();return d-=b.position().top,b.height(d),a("#"+this.bdiv).height(d),a("#"+this.bdiv).width(b.width()),Blockly.svgResize(this.workspacePlayground),!1},this.undo=function(){m&&this.workspacePlayground.undo(!1)},this.redo=function(){m&&this.workspacePlayground.undo(!0)},this.interpreter=!1,this.animateRun=!1,this.RUNSTATE=1,this.STEPSTATE=2,this.STOPSTATE=3,this.executionState=this.STOPSTATE,this.goNext=!1,this.initRun=function(a){function b(a,b){var e=function(b){return b=b?b.toString()+"\r\n":b+"\r\n",a.createPrimitive(d.writeLocal(b))};a.setProperty(b,"alert",a.createNativeFunction(e)),e=function(a,b){a=a?a.toString():""+a,d.writeLocal(a),d.setDataCallback(function(a){d.writeLocal("\n"),b(a)})},a.setProperty(b,"prompt",a.createAsyncFunction(e)),e=function(a){a==n.breakpoint&&(n.executionState=n.STEPSTATE,n.updateRunButtons(),h.getTerminal().setMessage(c.str("breakpoint"))),(n.animateRun||n.executionState==n.STEPSTATE)&&n.workspacePlayground.highlightBlock(a),n.goNext=!1},a.setProperty(b,"highlightBlock",a.createNativeFunction(e))}var d=h.getTerminal();d.isConnected()&&d.closeLocal(),this.animateRun=a,Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n",Blockly.JavaScript.addReservedWords("highlightBlock");var e=Blockly.JavaScript.workspaceToCode(n.workspacePlayground);n.interpreter=new Interpreter(e,b),d.connectLocal(n.stop,function(){})},this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,"this":!0,window:!0},this.breakpoint="",this.getVarValue=function(a){var b="";if(null===a)b="<b>null</b>";else if(void 0!=a){var d=typeof a;if("string"==d)b='"'+c.sanitizeText(a)+'"';else if("boolean"==d)b="<b>"+a+"</b>";else if("object"==d&&"Array"===a["class"]){b="[";for(var e=a.properties,f=0;f<e.length;f++)b+=n.getVarValue(e[f]),f!=e.length-1&&(b+=", ");b+="]"}else"object"==d?b="<b>"+a.toString()+"</b>":b+=""+a}return b},this.getVariables=function(a){var b="";for(var c in a)if(this.reservedWords[c]!==!0){var d=a[c];void 0!=d&&"Function"!==d["class"]&&(b+="<b>"+c+"</b>: "+n.getVarValue(d)+"<br>\n")}return b},this.getParameters=function(a){for(var b="(",c=0;c<a.length;c++)b+=""+a[c],c<a.length-1&&(b+=", ");return b+")"},this.showStack=function(a){for(var b=0,c='<table class="generaltable">',d=a.stateStack,e="<tr><td>0</td><td><b>Globals</b></td>",f=0;f<d.length;f++){var g=d[f];e>""&&("CallExpression"==g.node.type||f==d.length-1)&&(c+=e+"<td>"+n.getVariables(g.scope.properties),c+="</td></tr>"),"CallExpression"==g.node.type&&(n.reservedWords[g.node.callee.name]!==!0&&void 0!=g.node.callee.name?(b++,e="<tr><td>"+b+"</td>",e+="<td>"+g.node.callee.name+n.getParameters(g.arguments_)+"</td>"):e="")}c+="</table>",h.setResult({variables:c})},this.runLoop=function(){if(n.interpreter){n.goNext=!0;for(var a=0;a<3e4&&n.goNext&&n.executionState!=n.STOPSTATE;a++)if(!n.interpreter||!n.interpreter.step()){n.executionState=n.STOPSTATE,n.updateRunButtons();break}return n.executionState==n.STOPSTATE?(n.workspacePlayground.highlightBlock(-1),h.getTerminal().closeLocal(),void h.setResult({variables:""})):void(n.executionState==n.RUNSTATE?setTimeout(n.runLoop,0):n.showStack(n.interpreter))}},this.start=function(){n.initRun(!1),n.executionState=n.RUNSTATE,n.updateRunButtons(),h.getTerminal().setMessage(c.str("start")),n.runLoop()},this.startAnimate=function(){n.initRun(!0),n.executionState=n.RUNSTATE,n.updateRunButtons(),h.getTerminal().setMessage(c.str("startanimate")),n.runLoop()},this.stop=function(){n.executionState=n.STOPSTATE,n.updateRunButtons(),h.getTerminal().setMessage(c.str("stop")),h.getTerminal().closeLocal(),n.interpreter=!1,h.setResult({variables:""})},this.pause=function(){n.executionState=n.STEPSTATE,h.getTerminal().setMessage(c.str("pause")),n.updateRunButtons()},this.resume=function(){n.executionState=n.RUNSTATE,h.getTerminal().setMessage(c.str("resume")),n.updateRunButtons(),n.runLoop()},this.step=function(){n.executionState==n.STOPSTATE&&n.initRun(!0),n.executionState=n.STEPSTATE,n.updateRunButtons(),h.getTerminal().setMessage(c.str("step")),n.runLoop()},this.hasUndo=function(){return!0},this.hasRedo=function(){return!0},this.oldSetFileName=this.setFileName,this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"},this.generator="",this.setFileName=function(a){var b=/\.([^.]+)\.blockly[123]?$/,d=/(.+)\.blockly[123]?$/,e=c.fileExtension(k);n.oldSetFileName(a);var f=b.exec(k),g=d.exec(k);null!==f&&null!==g&&"string"==typeof this.generatorMap[f[1]]?(this.generator=this.generatorMap[f[1]],this.generatedFilename=g[1]):this.generator="",null!==g&&e!=c.fileExtension(k)&&this.setToolbox()},this.changeCode=function(a){if("ui"==a.type&&"selected"==a.element)return void(n.breakpoint=a.newValue);if("ui"==a.type&&"category"==a.element&&a.newValue==c.str("run"))return void n.updateRunButtons();if(a.recordUndo&&(n.change(),""!=this.generator)){var b=Blockly[this.generator].workspaceToCode(n.workspacePlayground),d=g.fileNameExists(this.generatedFilename);if(d==-1&&(g.addFile({name:this.generatedFilename,contents:""},!1,c.doNothing,c.doNothing),d=g.fileNameExists(this.generatedFilename)),d!=-1){var e=g.getFile(d);e.setContent(b),e.change(),e.gotoLine(1),e.setReadOnly(!0)}}},this.updateRunButtons=function(){switch(n.executionState){case n.RUNSTATE:a(".blocklyStartC").hide(),a(".blocklyStartAnimateC").hide(),a(".blocklyStopC").show(),a(".blocklyPauseC").show(),a(".blocklyResumeC").hide(),a(".blocklyStepC").hide();break;case n.STEPSTATE:a(".blocklyStartC").hide(),a(".blocklyStartAnimateC").hide(),a(".blocklyStopC").show(),a(".blocklyPauseC").hide(),a(".blocklyResumeC").show(),a(".blocklyStepC").show();break;case n.STOPSTATE:a(".blocklyStartC").show(),a(".blocklyStartAnimateC").show(),a(".blocklyStopC").hide(),a(".blocklyPauseC").hide(),a(".blocklyResumeC").hide(),a(".blocklyStepC").show()}},this.setToolbox=function(){var b=c.fileExtension(k),e=b+"Toolbox";return d[e]===!1?void a.ajax({url:"../editor/blocklytoolboxes/"+e+".xml",dataType:"text",success:function(a){d[e]=d.blocklyIn18(a),n.setToolbox()}}):(this.workspacePlayground.updateToolbox(d[e]),this.workspacePlayground.registerButtonCallback("blocklyStartButton",this.start),this.workspacePlayground.registerButtonCallback("blocklyStartAnimateButton",this.startAnimate),this.workspacePlayground.registerButtonCallback("blocklyStopButton",this.stop),this.workspacePlayground.registerButtonCallback("blocklyPauseButton",this.pause),this.workspacePlayground.registerButtonCallback("blocklyResumeButton",this.resume),this.workspacePlayground.registerButtonCallback("blocklyStepButton",this.step),void this.adjustSize())},this.open=function(){if(m=!0,this.setFileName(k),m=!1,d.blocklyNotLoaded)return void c.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js","../editor/blockly/python_compressed.js","../editor/blockly/javascript_compressed.js","../editor/blockly/php_compressed.js","../editor/blockly/lua_compressed.js","../editor/blockly/dart_compressed.js","../editor/acorn/acorn.js","../editor/acorn/interpreter.js"],function(){n.adaptBlockly(),d.blocklyNotLoaded=!1,n.open()});m=!0;var e=!1;if(/.*[0-9]$/.test(c.fileExtension(k)))var e=!0;a(i).removeClass("ui-widget-content ui-tabs-panel"),a(i).addClass("ui-corner-bottom"),this.bdiv="bkdiv"+b,a(i).html('<div id="'+this.bdiv+'" style="height: 480px; width: 600px;"></div>');var f={toolbox:'<xml><category name=""><block type="math_number"></block></category></xml>',media:"../editor/blockly/media/",horizontalLayout:e,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:1.15}};return this.workspacePlayground=Blockly.inject(this.bdiv,f),this.workspacePlayground.addChangeListener(function(a){n.changeCode(a)}),this.setToolbox(),!1},this.getContent=function(){if(!m)return f;var a=Blockly.Xml.workspaceToDom(this.workspacePlayground),b=Blockly.Xml.domToPrettyText(a);return b},this.setContent=function(a){if(f=a,m){this.workspacePlayground.clear();var b=Blockly.Xml.textToDom(a);Blockly.Xml.domToWorkspace(b,this.workspacePlayground)}},this.close=function(){f=this.getContent(),this.workspacePlayground.dispose(),this.workspacePlayground=!1,this.firstFocus=!0,m=!1}},this.extendToBinary=function(){this.isBinary=function(){return!0},this.setContent=function(a){l=!0,f=a,this.setFileName(k),this.updateDataURL()},this.updateDataURL=function(){if(c.isImage(k)){var b="data:"+c.getMIME(k)+";base64,";a(i).find("img").attr("src",b+f)}else a(i).find("img").attr("src","")},this.adjustSize=function(){if(!m)return!1;var b=a(i);if(0!==b.length){var c=b.parent(),d=c.height();return d-=b.position().top,d!=b.height()&&(b.height(d),!0)}},this.open=function(){return m=!0,c.isImage(k)?(a(i).addClass("vpl_ide_img").append("<img />"),this.updateDataURL()):a(i).addClass("vpl_ide_binary").text(c.str("binaryfile")),this.setFileName(k),!1},this.close=function(){m=!1}}};return d.blocklyNotLoaded=!0,d.blocklyToolbox=!1,d.blockly0Toolbox=!1,d.blockly1Toolbox=!1,d.blockly2Toolbox=!1,d.blockly3Toolbox=!1,d.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step"],d.blocklyIn18=function(a){for(var b=d.blocklyStrs.length,e=0;e<b;e++){var f=d.blocklyStrs[e],g=new RegExp("\\[\\["+f+"\\]\\]","g"),h=c.str(f);a=a.replace(g,h)}return a},window.VPLFile=d,d});